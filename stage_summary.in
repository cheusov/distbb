#!/bin/sh

# Copyright (c) 2008-2011 Aleksey Cheusov <vle@gmx.net>
# All rights reserved.
#
# See LICENSE file

######################################################################

set -e

# usage: stage_upload_logs BUILD_ID
test $# -eq 1

# init
BUILD_ID="$1"

DISTBB_CONF=${DISTBB_CONF:-@sysconfdir@/distbb.conf}
. "$DISTBB_CONF"
. @libexecdir@/common

# main
verbose_print "Generating package summaries..."

summary_pkgs_fn=$tmpdir/summary_pkgs.tmp
awk 'NF == 2 {hash [$1] = hash [$2] = ""}
     NF == 1 {hash [$1] = ""}
     END {for (p in hash) print p }' "$reqd_deps_fn" |
sort > "$summary_pkgs_fn"

runawk -f xgetline.awk -v summary_pkgs_fn="$summary_pkgs_fn" -e '
BEGIN {
   while(xgetline0(summary_pkgs_fn)){
      all_pkgs [$1] = 0
   }
}
{ failed_pkgs [$2] = 0 }
END {
   for (p in all_pkgs)
      if (!(p in failed_pkgs))
         print p
}
' $REPORT1_DIR/META/packages_failed_*.txt > "$tmpdir/pkgs2summary.tmp"

cd "$PACKAGES/All"

NA2filename () {
    awk -v sufx="$PKG_SUFX" '{print "./" $1 sufx}' "$@"
}

pkg_summary_tmp_fn="$REPORT1_DIR/META/pkg_summary.txt"
NA2filename "$tmpdir/pkgs2summary.tmp" |
xargs pkg_bin_summary \
    > "$pkg_summary_tmp_fn"
cp "$pkg_summary_tmp_fn" "$PKG_SUMMARY"

pkg_enriched_summary_tmp_fn="$REPORT1_DIR/META/pkg_enriched_summary.txt"
NA2filename  "$tmpdir/pkgs2summary.tmp" |
xargs pkg_bin_summary -f PKGNAME,PKGPATH,COMMENT,PLIST \
    > "$pkg_enriched_summary_tmp_fn"

"$GZIP" < "$PKG_SUMMARY" > "${PKG_SUMMARY%.txt}.gz"
"$BZIP2" < "$PKG_SUMMARY" > "${PKG_SUMMARY%.txt}.bz2"

verbose_print "done\n"
