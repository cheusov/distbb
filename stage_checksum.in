#!/bin/sh

# Copyright (c) 2008-2011 Aleksey Cheusov <vle@gmx.net>
# All rights reserved.
#
# See LICENSE file

######################################################################

set -e

# usage: stage_upload_logs BUILD_ID
test $# -eq 1

# init
BUILD_ID="$1"

DISTBB_CONF=${DISTBB_CONF:-@sysconfdir@/distbb.conf}
. "$DISTBB_CONF"
. @libexecdir@/common

# main
verbose_print "Generating checksums for binary packages..."

total_pkgs=$REPORT1_DIR/META/packages_built_total.txt
cd "$PACKAGES"

{
    echo "All/pkg_summary.bz2"
    echo "All/pkg_summary.gz"
    echo "All/pkg_summary.txt"
    awk -v sufx="$PKG_SUFX" 'NF == 3 {print "All/" $2 sufx}' "$total_pkgs" |
    sort
} | xargs "@bindir@/digest" SHA512 > SHA512.txt

"$GZIP"  < SHA512.txt > SHA512.gz
"$BZIP2" < SHA512.txt > SHA512.bz2

verbose_print "done\n"
