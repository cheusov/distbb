#!/bin/sh

# Copyright (c) 2008-2010 Aleksey Cheusov <vle@gmx.net>
# All rights reserved.
#
# See LICENSE file

######################################################################

#
# run 'make depends' with changed DEPENDS and BUILD_DEPENDS.
# Alternative dependencies are removed.
#

# $1 - enriched pkgpath

set -e

export PATH=@bindir@:$PATH

if test -z "$PKG_ADD"; then
	echo 'PKG_ADD must be set' 1>&2
	exit 1
fi

if test -z "$PACKAGES"; then
	echo 'PACKAGES must be set' 1>&2
	exit 1
fi

if test -z "$aux_reqd_deps_fn"; then
	echo '$aux_reqd_deps_fn must be set' 1>&2
	exit 1
fi

test $# -eq 1

get_deps (){
    pkg_subgraph_deps -rxt -p "$1" "$aux_reqd_deps_fn" | tsort
}

unset PKG_PATH || true

pkgs_deps=`get_deps $1`
echo 'Packages to install:'
for p in $pkgs_deps; do
    echo " $p"
done
echo ''

echo 'Installing'
for p in $pkgs_deps; do
    $PKG_ADD "$PACKAGES/All/$p$PKG_SUFX"
done
