#!/bin/sh

# Copyright (c) 2008-2014 Aleksey Cheusov <vle@gmx.net>
# All rights reserved.
#
# See LICENSE file

######################################################################

# distbb_chroot is a ssh/rsh-like transport programs used by distbb(1)
# usage: distbb_chroot <chroot_rootdir> <chroot_id> <cmd> <args>
# example:
#     mkdir /var/chroot/box1
#     mkdir /var/chroot/box2
#     cp -Rp /bin /sbin ... /var/chroot/box1
#     cp -Rp /bin /sbin ... /var/chroot/box2
#     distbb_chroot /var/chroot/ box1 ls -la /
#     distbb_chroot /var/chroot/ box2 ls -la /

root="$1"
shift

id="$1"
shift

if test -z "$DISTBB_CONF"; then
    echo 'distbb_chroot: DISTBB_CONF cannot be empty' 1>&2
    exit 1
fi

shquote (){
    __cmd=`printf '%s\n' "$1" | sed "s|'|'\\\\\''|g"`
    printf "%s\n" "'$__cmd'"
}

shquote_all (){
    for i in "$@"; do
	shquote "$i"
	printf ' '
    done
}

cmd=`shquote_all "$@"`

# and DISTBB_CONF for "slave" script
env="$env DISTBB_CONF='$DISTBB_CONF'"

#echo cmd="$cmd" 1>&2
#echo '$root$id='$root$id 1>&2

$DISTBB_SUDO chroot $root$id sh -c "eval env $env $cmd"
